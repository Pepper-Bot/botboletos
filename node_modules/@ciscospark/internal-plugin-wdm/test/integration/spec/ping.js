/*!
 * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.
 */

import '@ciscospark/internal-plugin-wdm';

import {inBrowser} from '@ciscospark/common';
import CiscoSpark from '@ciscospark/spark-core';
import testUsers from '@ciscospark/test-helper-test-users';

describe('plugin-wdm', function () {
  describe('Device', () => {
    this.timeout(30000);
    describe('.services', () => {
      let spark;

      before('create user', () => testUsers.create({count: 1})
        .then((users) => {
          spark = new CiscoSpark({
            credentials: {
              supertoken: users[0].token
            }
          });
        }));

      before('register device', () => spark.internal.device.register());

      const knownServices = [
        'acl',
        'apheleia',
        'argonaut',
        'assistant',
        'atlas',
        'avatar',
        'board',
        'calendar',
        'calliopeDiscovery',
        'conversation',
        'deviceManagement',
        'encryption',
        'feature',
        'files',
        'hecate',
        'hydra',
        'identityLookup',
        'janus',
        'locus',
        'lyra',
        'mercuryConnection',
        'metrics',
        'proximity',
        'raindrop',
        'remoteDispatcher',
        'retention',
        'room',
        'squaredFiles',
        'swupgrade',
        'userApps',
        'voicemail',
        'wdm'
      ];

      /**
       * This list contains services that may be in the service with an improper
       * key or have been/will soon be decommissioned but are still in the
       * catalog.
       */
      const unreachableServices = [
        'mercuryAlternateDC',
        'speechServicesManagerUrl',
        'stickies'
      ];

      knownServices.forEach((service) => {
        describe(`.${service}`, () => {
          it('responds to pings', () => ping(service));
        });
      });

      describe('each service written after the test suite was created', () => {
        it('responds to pings', () => Object.keys(spark.internal.device.services)
          .map((service) => service.replace('ServiceUrl', ''))
          .filter((service) => !knownServices.includes(service))
          .filter((service) => !knownServices.includes(service) && !unreachableServices.includes(service))
          .reduce((p, service) => p.then(() => ping(service)), Promise.resolve()));
      });

      function ping(service) {
        return spark.request({
          service,
          resource: '/ping'
        })
          .catch((res) => {
            if (res && res.statusCode === 0) {
              if (!inBrowser) {
                throw new Error(`Network failure pinging "${service}" service\nThis often happens when a service is added to the service catalog before being deployed\n${res}`);
              }

              throw new Error(`Network error or CORS misconfigured on "${service}" service\nThis often happens when a service is added to the service catalog before being deployed\n${res}`);
            }

            throw res;
          });
      }
    });
  });
});
